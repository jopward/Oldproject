{% include 'partials/header.html' %}
{% include 'partials/navbar.html' %}

<div class="container mt-4">

    <h1 class="mb-4">قائمة الطلاب</h1>

    <!-- نموذج إضافة طلاب جدد -->
    <div class="card mb-4 p-3">
        <h4>إضافة طلاب جدد</h4>
        <form method="POST" id="addStudentForm">
            <input type="hidden" name="action" value="add">

            <div class="mb-2">
                <label>الأسماء (ضع كل اسم في سطر جديد):</label>
                <textarea name="student_names" rows="5" class="form-control" placeholder="مثال:&#10;محمد علي محمد&#10;أحمد محمود عثمان" required></textarea>
            </div>

            <div class="mb-2">
                <label>الصف:</label>
                <input type="text" name="class_name" required class="form-control">
            </div>

            <div class="mb-2">
                <label>الشعبة:</label>
                <select name="section" required class="form-control">
                    <option value="أ">أ</option>
                    <option value="ب">ب</option>
                    <option value="ج">ج</option>
                    <option value="د">د</option>
                </select>
            </div>

            <button type="submit" class="btn btn-primary mt-2">إضافة</button>
        </form>
    </div>

    <!-- جدول عرض الطلاب -->
    <div class="card p-3">
        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>الاسم</th>
                    <th>الصف</th>
                    <th>الشعبة</th>
                    <th>إجراءات</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr data-student-id="{{ student.id }}">
                    <td class="name">{{ student.student_name }}</td>
                    <td class="class">{{ student.class_name }}</td>
                    <td class="section">{{ student.section }}</td>
                    <td>
                        <button class="btn btn-sm btn-warning editBtn">تعديل</button>
                        <button class="btn btn-sm btn-success saveBtn" style="display:none;">حفظ</button>
                        <button class="btn btn-sm btn-danger deleteBtn">حذف</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    // حذف طالب
    document.querySelectorAll(".deleteBtn").forEach(btn => {
        btn.addEventListener("click", () => {
            const row = btn.closest("tr");
            const studentId = row.dataset.studentId;
            if(confirm("هل تريد حذف هذا الطالب؟")) {
                fetch(`/delete_student/${studentId}`, { method: "POST" })
                    .then(res => res.json())
                    .then(data => {
                        if(data.success) row.remove();
                    });
            }
        });
    });

    // تعديل طالب inline
    document.querySelectorAll(".editBtn").forEach(btn => {
        btn.addEventListener("click", () => {
            const row = btn.closest("tr");
            const nameCell = row.querySelector(".name");
            const classCell = row.querySelector(".class");
            const sectionCell = row.querySelector(".section");

            const name = nameCell.textContent;
            const className = classCell.textContent;
            const section = sectionCell.textContent;

            nameCell.innerHTML = `<input type="text" class="form-control" value="${name}">`;
            classCell.innerHTML = `<input type="text" class="form-control" value="${className}">`;
            sectionCell.innerHTML = `
                <select class="form-control">
                    <option value="أ" ${section==="أ"?"selected":""}>أ</option>
                    <option value="ب" ${section==="ب"?"selected":""}>ب</option>
                    <option value="ج" ${section==="ج"?"selected":""}>ج</option>
                    <option value="د" ${section==="د"?"selected":""}>د</option>
                </select>
            `;

            btn.style.display = "none";
            const saveBtn = row.querySelector(".saveBtn");
            saveBtn.style.display = "inline-block";

            saveBtn.addEventListener("click", () => {
                const newName = nameCell.querySelector("input").value;
                const newClass = classCell.querySelector("input").value;
                const newSection = sectionCell.querySelector("select").value;
                const studentId = row.dataset.studentId;

                fetch(`/edit_student/${studentId}`, {
                    method: "POST",
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        student_name: newName,
                        class_name: newClass,
                        section: newSection
                    })
                }).then(res => res.json())
                  .then(data => {
                    if(data.success) {
                        nameCell.textContent = newName;
                        classCell.textContent = newClass;
                        sectionCell.textContent = newSection;

                        btn.style.display = "inline-block";
                        saveBtn.style.display = "none";
                    }
                  });
            });
        });
    });

});
</script>

{% include 'partials/footer.html' %}
