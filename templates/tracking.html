{% include 'partials/header.html' %}
{% include 'partials/navbar.html' %}

<style>
#trackingTable thead th {
    position: sticky;
    top: 0;
    background: #f8f9fa; /* لون خلفية زي bootstrap */
    z-index: 10;
}
</style>

<div class="container my-3">

    <div class="d-flex justify-content-between mb-2">
        <div><strong>اليوم والتاريخ: </strong> {{ today }}</div>
        <div>
            <strong>الصف: </strong>
            <select id="classSelect" class="form-control d-inline-block w-auto">
                <option value="">اختر صف</option>
                {% for c in classes %}
                <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
            </select>
            <strong>الشعبة: </strong>
            <select id="sectionSelect" class="form-control d-inline-block w-auto">
                <option value="">اختر شعبة</option>
                {% for s in sections %}
                <option value="{{ s }}">{{ s }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <table class="table table-bordered" id="trackingTable">
        <thead class="table-light">
            <tr>
                <th>الاسم</th>
                <th>واجب</th>
                <th>كتاب</th>
                <th>مشاركة</th>
                <th>مشاغبة</th>
                <th>ملاحظة</th>
            </tr>
        </thead>
        <tbody>
            {% for student in students %}
            {% set rec = records.get(student.id, {}) %}
            <tr data-class="{{ student.class_name }}" data-section="{{ student.section }}">
                <td>{{ student.student_name }}</td>
                <td><input type="checkbox" class="track-checkbox" data-student="{{ student.id }}" data-field="homework" {% if rec.homework %}checked{% endif %}></td>
                <td><input type="checkbox" class="track-checkbox" data-student="{{ student.id }}" data-field="book" {% if rec.book %}checked{% endif %}></td>
                <td><input type="checkbox" class="track-checkbox" data-student="{{ student.id }}" data-field="participation" {% if rec.participation %}checked{% endif %}></td>
                <td><input type="checkbox" class="track-checkbox" data-student="{{ student.id }}" data-field="misbehavior" {% if rec.misbehavior %}checked{% endif %}></td>
                <td>
                    <button class="btn btn-sm btn-warning note-btn" data-student="{{ student.id }}" {% if rec.note %}style="background:red"{% endif %}>
                        {% if rec.note %}تم إدخال ملاحظة{% else %}إضافة ملاحظة{% endif %}
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- نافذة الملاحظة المنبثقة -->
<div id="noteModal" class="modal" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:white; padding:20px; border:1px solid #ccc; z-index:1000;">
    <h5>إدخال ملاحظة</h5>
    <textarea id="noteText" rows="5" cols="50"></textarea><br><br>
    <button id="saveNote" class="btn btn-primary">حفظ</button>
    <button id="closeNote" class="btn btn-secondary">إغلاق</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // تحديث الشيك بوكس
    document.querySelectorAll(".track-checkbox").forEach(chk => {
        chk.addEventListener("change", () => {
            const studentId = chk.dataset.student;
            const field = chk.dataset.field;
            const value = chk.checked ? 1 : 0;
            fetch("/update_tracking", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({student_id: studentId, field: field, value: value})
            });
        });
    });

    // نافذة الملاحظة
    let currentStudentId = null;
    const modal = document.getElementById("noteModal");
    const noteText = document.getElementById("noteText");

    document.querySelectorAll(".note-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            currentStudentId = btn.dataset.student;
            noteText.value = "";
            modal.style.display = "block";
        });
    });

    document.getElementById("saveNote").addEventListener("click", () => {
        fetch("/update_note", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({student_id: currentStudentId, note: noteText.value})
        }).then(() => {
            modal.style.display = "none";
            const btn = document.querySelector(`.note-btn[data-student='${currentStudentId}']`);
            btn.style.background = "red";
            btn.textContent = "تم إدخال ملاحظة";
        });
    });

    document.getElementById("closeNote").addEventListener("click", () => {
        modal.style.display = "none";
    });

    // فلترة الجدول عند اختيار الصف أو الشعبة
    const classSelect = document.getElementById("classSelect");
    const sectionSelect = document.getElementById("sectionSelect");
    const tableRows = document.querySelectorAll("#trackingTable tbody tr");

    function filterTable() {
        const selectedClass = classSelect.value;
        const selectedSection = sectionSelect.value;

        tableRows.forEach(row => {
            const rowClass = row.dataset.class;
            const rowSection = row.dataset.section;
            let show = true;
            if(selectedClass && rowClass !== selectedClass) show = false;
            if(selectedSection && rowSection !== selectedSection) show = false;
            row.style.display = show ? "" : "none";
        });
    }

    classSelect.addEventListener("change", filterTable);
    sectionSelect.addEventListener("change", filterTable);
});
</script>

{% include 'partials/footer.html' %}
