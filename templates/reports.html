{% include 'partials/header.html' %}
{% include 'partials/navbar.html' %}

<div class="container my-3">

    <div class="d-flex justify-content-between mb-3">
        <div><strong>تاريخ اليوم:</strong> {{ today }}</div>
        <div>
            <strong>الصف:</strong>
            <select id="classSelect" class="form-select d-inline-block w-auto">
                <option value="all">اختر صف</option>
                {% for cls in classes %}
                <option value="{{ cls }}">{{ cls }}</option>
                {% endfor %}
            </select>

            <strong>الشعبة:</strong>
            <select id="sectionSelect" class="form-select d-inline-block w-auto">
                <option value="all">اختر شعبة</option>
                {% for sec in sections %}
                <option value="{{ sec }}">{{ sec }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-striped text-center" id="reportsTable">
            <thead class="table-light sticky-top">
                <tr>
                    <th>الاسم</th>
                    <th>حاضر</th>
                    <th>متأخر</th>
                    <th>غائب</th>
                    <th>واجب</th>
                    <th>كتاب</th>
                    <th>مشاركة</th>
                    <th>مشاغبة</th>
                    <th>ملاحظة</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr data-class="{{ student.class_name }}" data-section="{{ student.section }}" class="{% if loop.index0 % 2 == 0 %}table-white{% else %}table-secondary{% endif %}">
                    <!-- العمود الأول: رابط للصفحة التفصيلية -->
                    <td>
                        <a href="{{ url_for('student_detail', student_id=student.id) }}">
                            {{ student.student_name }}
                        </a>
                    </td>
                    <td class="clickable" data-student="{{ student.id }}" data-status="present">{{ student.present_count or 0 }}</td>
                    <td class="clickable" data-student="{{ student.id }}" data-status="late">{{ student.late_count or 0 }}</td>
                    <td class="clickable" data-student="{{ student.id }}" data-status="absent">{{ student.absent_count or 0 }}</td>
                    <td class="clickable" data-student="{{ student.id }}" data-field="homework">{{ student.homework or 0 }}</td>
                    <td class="clickable" data-student="{{ student.id }}" data-field="book">{{ student.book or 0 }}</td>
                    <td class="clickable" data-student="{{ student.id }}" data-field="participation">{{ student.participation or 0 }}</td>
                    <td class="clickable" data-student="{{ student.id }}" data-field="misbehavior">{{ student.misbehavior or 0 }}</td>
                    <td>
                        <input type="text" class="note-input form-control {% if student.note %}has-note{% endif %}" 
                               value="{{ student.note or '' }}" 
                               data-student="{{ student.id }}">
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const table = document.getElementById("reportsTable");
    const classSelect = document.getElementById("classSelect");
    const sectionSelect = document.getElementById("sectionSelect");

    // ترشيح الجدول حسب الصف والشعبة عند الاختيار
    function filterTable() {
        const selectedClass = classSelect.value;
        const selectedSection = sectionSelect.value;

        [...table.tBodies[0].rows].forEach(row => {
            const rowClass = row.dataset.class;
            const rowSection = row.dataset.section;

            if ((selectedClass === "all" || rowClass === selectedClass) &&
                (selectedSection === "all" || rowSection === selectedSection)) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });

        // ترتيب حسب الصف → الشعبة → الاسم
        const rowsArray = [...table.tBodies[0].rows].filter(r => r.style.display !== "none");
        rowsArray.sort((a, b) => {
            if (a.dataset.class !== b.dataset.class) return a.dataset.class.localeCompare(b.dataset.class);
            if (a.dataset.section !== b.dataset.section) return a.dataset.section.localeCompare(b.dataset.section);
            return a.cells[0].textContent.localeCompare(b.cells[0].textContent);
        });
        rowsArray.forEach(r => table.tBodies[0].appendChild(r));
    }

    classSelect.addEventListener("change", filterTable);
    sectionSelect.addEventListener("change", filterTable);

    // تحديث الملاحظات مباشرة عند التعديل
    document.querySelectorAll(".note-input").forEach(input => {
        input.addEventListener("change", () => {
            const studentId = input.dataset.student;
            const note = input.value;

            fetch('/update_note', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ student_id: studentId, note })
            }).then(() => {
                if(note.trim() !== "") {
                    input.classList.add("has-note");
                } else {
                    input.classList.remove("has-note");
                }
            });
        });
    });

    // تفاصيل الحضور والمتابعة عند النقر
    table.querySelectorAll(".clickable").forEach(cell => {
        cell.addEventListener("click", () => {
            const studentId = cell.dataset.student;
            const status = cell.dataset.status;
            const field = cell.dataset.field;

            if (status) {
                fetch(`/get_attendance_details/${studentId}/${status}`)
                    .then(res => res.json())
                    .then(dates => {
                        alert(dates.length ? `${status.toUpperCase()}:\n` + dates.join("\n") : `لا توجد سجلات ${status.toUpperCase()}`);
                    });
            } else if (field) {
                fetch(`/get_tracking_details/${studentId}/${field}`)
                    .then(res => res.json())
                    .then(dates => {
                        alert(dates.length ? `${field.toUpperCase()}:\n` + dates.join("\n") : `لا توجد سجلات ${field.toUpperCase()}`);
                    });
            }
        });
    });
});
</script>

{% include 'partials/footer.html' %}
